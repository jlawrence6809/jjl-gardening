<html>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});

      let dataHoldingSemaphore = null;
      google.charts.setOnLoadCallback(() => {
        if(dataHoldingSemaphore){
          drawChart(dataHoldingSemaphore);
        } else {
          dataHoldingSemaphore = true;
        }
      });

      let xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() { 
          if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
             if(dataHoldingSemaphore){
              drawChart(xmlHttp.responseText);
             } else {
              dataHoldingSemaphore = xmlHttp.responseText;
             }
          }
      }
      xmlHttp.open("GET", "/data", true); // true for asynchronous 
      xmlHttp.send(null);

      function drawChart(dataStr) {
        try{
          let tablesData = JSON.parse(dataStr);
          Object.keys(tablesData).forEach( t => {
            let tableData = google.visualization.arrayToDataTable(tablesData[t]);

            let options = {
              title: t,
              curveType: 'function',
              interpolateNulls: true,
              legend: { position: 'bottom' }
            };
            let root = document.createElement("div");
            root.id = t;
            root.style = "width: 1900px; height: 500px";
            document.body.appendChild(root);

            let chart = new google.visualization.LineChart(root);

            chart.draw(tableData, options);
          });
        } catch(e) {
          console.log(e);
          console.log(dataStr);
          alert("Could not parse data!");
          return;
        }
      }
    </script>
  </head>
  <body>
  </body>
</html>
